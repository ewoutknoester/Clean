---
title: "Clean"
author: "Ewout Knoester"
date: "25 May 2021"
output: html_document
---

# Setup
```{r setup, include=FALSE}
rm(list=ls()) # Clear workspace
knitr::opts_knit$set(root.dir = '/tmp') #Set directory at current directory for all subsequent chunks

library(readxl) # Import excel sheets
library(tidyverse) # Tidy data
library(panelr) # Convert data from wide to long
library(nlme) # GLS
library(emmeans) # Pairwise comparisons
library(betareg) # Beta regression
library(ggthemes) # Pretty plots
library(car) # ANOVA results GLM
library(NCmisc) # Check packages used
library(writexl)
library(cowplot) # Combine plots

# Function to facilitate averaging datasets
data_summary <- function(data, varname, groupnames){
  require(plyr)
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE),
      n  = length(x[[col]]),
      se = sd(x[[col]], na.rm=TRUE)/sqrt(length(x[[col]])))
  }
  data_sum<-ddply(data, groupnames, .fun=summary_func,
                  varname)
  data_sum <- rename(data_sum, c("mean" = varname))
 return(data_sum)
}
```

# Data selection (preparing dataset for archiving & sharing)
```{r data selection, include=FALSE}

# Import excel sheet
raw.data <- read_excel("Raw data/cleaning_exp.xlsx", sheet = "RAW DATA") 
  
# Insert new columns Treatment & Size
raw.data.1 <- as.data.frame(append(raw.data,list(Treatment = "",Size = ""), after = 7))

## Fill Size with conditional values from Length: ie make start length a categorical variable (small, medium, large)
raw.data.1$Size <- ifelse(raw.data.1$Length.S1 < 3.4, "Small",
                   ifelse(raw.data.1$Length.S1 < 6.4, "Medium", "Large"))

## Fill Treatment with conditional values from Structure
raw.data.1$Treatment <- ifelse(raw.data.1$Structure %in% c("Tree 095", "Tree 089", "Tree 079"), "Weekly",
                        ifelse(raw.data.1$Structure %in% c("Tree 092", "Tree 093", "Tree 088"), "Monthly",
                        ifelse(raw.data.1$Structure %in% c("Tree 099", "Tree 098", "Tree 094"), "Quarterly",
                                                                                                "Never")))

# Insert new columns to calculate average SGR over whole 1-year period while maintaining same wide-format style data
raw.data.1 <- as.data.frame(append(raw.data.1, list(Date.S8 = "2019-12-24", Length.S8 = NA,
              Width1.S8 = NA, Width2.S8 = NA, EV.S8 = NA, Condition.S8 = NA, Cause_death.S8 = NA, s_g_r.S8 = NA, 
              Comments.S8 = NA), after = 73))

## Calculate SGR (Specific Growth Rate) over whole period
raw.data.1$s_g_r.S8 <- log(raw.data.1$EV.S7/raw.data.1$EV.S1)/as.numeric(as.Date(as.character(raw.data.1$Date.S7), 
                       format="%Y-%m-%d") - as.Date(as.character(raw.data.1$Date.S1), format="%Y-%m-%d"))

## Calculate increase in EV as percentage over whole period (NB: expressed as percentage per year, as opposed to other EV values): value of 100% meaning it doubled in size 
raw.data.1$EV.S8 <- ((raw.data.1$EV.S7 - raw.data.1$EV.S1)/raw.data.1$EV.S1)*100

### Standardize percentage increase in volume to one year (experiment duration was slightly longer than a year)
raw.data.1$EV.S8 <- 100*exp((log((raw.data.1$EV.S8+100)/100)/(as.numeric(as.Date(as.character(raw.data.1$Date.S7), 
    format="%Y-%m-%d") - as.Date(as.character(raw.data.1$Date.S1), format="%Y-%m-%d"))))*365)-100

## Fill in end Condition for Average time factor (NB: end Condition will be used in analysis)
raw.data.1$Condition.S8 <- raw.data.1$Condition.S7
raw.data.1$Cause_death.S8 <- raw.data.1$Cause_death.S7

# Convert to long data frame
raw.data.2 <- as.data.frame(long_panel(raw.data.1, prefix = ".S", begin = 1, end = 8, label_location = "end"))

# Set correct names and data formats
## Renaming SGR
raw.data.2 %<>%
  dplyr::rename(SGR = s_g_r)

## Set species and rename
species.order = c("Acropora formosa", 
                  "Acropora verweyi", 
                  "Pocillopora verucosa", 
                  "Porites cylindrica")
raw.data.2 %<>% 
  mutate(Species = Species %>% 
           factor(levels = species.order) %>% 
           fct_recode('Pocillopora verrucosa' = "Pocillopora verucosa",
                      'Acropora cf muricata' = "Acropora formosa"))

## Read in NAs properly
raw.data.2$SGR[raw.data.2$SGR == "NA"] <- NA
raw.data.2$Cause_death[raw.data.2$Cause_death == "NA"] <- NA

## Set correct data types
raw.data.2$SGR <- as.numeric(raw.data.2$SGR)
raw.data.2$Date <- format(raw.data.2$Date, "%m/%Y")

## Merge overlapping months for visualization purposes
date.order = c("09/2018", "10/2018", "12/2018", 
               "02/2019", "04/2019", "05/2019", 
               "06/2019", "08/2019", "10/2019", 
               "12/2019")

raw.data.2 %<>%
  mutate(Date = Date %<>% 
           factor(levels = date.order) %>% 
           fct_recode('10/2018' = '09/2018',
                      '04/2019' = '05/2019',
                      'Average' = '12/2019'))

# Drop and reorder some columns
clean.data <- raw.data.2 %>%
  select(c("id", "Position", "Structure", "Species", "Treatment", "Size", 
           "Date", "Length", "Cause_death", "Condition", "SGR", "EV")) 

# Tidy formatting data frame
clean.data$Length <- round(clean.data$Length, 1)
clean.data$EV <- round(clean.data$EV, 0)
clean.data$SGR <- round(clean.data$SGR, 3)

# Export data selection
write_xlsx(clean.data, "Cleaning experiment.xlsx")

```

# Data cleaning
```{r data cleaning}

# Import excel sheet
clean.data <- read_excel("Cleaning experiment.xlsx", sheet = 1)

# Set correct data types
clean.data$Structure <- factor(clean.data$Structure)
clean.data$Size <- ordered(clean.data$Size, levels = c("Small", "Medium", "Large"))
clean.data$Treatment <- ordered(clean.data$Treatment, c("Weekly", "Monthly", "Quarterly", "Never"))
clean.data$Species <- as.factor(clean.data$Species)
clean.data$SGR <- as.numeric(clean.data$SGR)
clean.data$Cause_death <- factor(clean.data$Cause_death)
clean.data$Date <- ordered(clean.data$Date, c("10/2018", "12/2018", "02/2019", "04/2019", "06/2019", "08/2019",
                                              "10/2019", "Average"))

# Remove rows with Exclude: influenced by factors of non-interest (e.g. corallivory, wrong start size/health)
clean.data.1 <- clean.data[-which(clean.data$Cause_death == "Exclude"),]

# Create subset to inspect missing values
missing <- subset(clean.data.1, Cause_death == "Missing")
missing <- subset(missing, Date == "10/2019")

## Summary of missing values 
### Indicating that missing fragments are roughly equally distributed across Treatments
summary(missing)

#! Decision to leave out missing fragments from analysis as pattern is not related to Treatment
clean.data.1 <- clean.data.1[-which(clean.data.1$Cause_death == "Missing"),]
clean.data.1 <- clean.data.1[clean.data.1$id != "597", ] # Remove observation without start values

```

# SGR analysis
## Model selection
```{r SGR: linear model selection}

# DATA PREP
## Create subset for SGR where Condition > 80: only healthy corals will be used to determine SGR
sgr.data <- subset(clean.data.1, Condition >= 80 | is.na(Condition))
sgr.data <- subset(sgr.data, !(is.na(SGR))) # Exclude SGR with NA

## Visualize time effect
sgr.data.summary <- data_summary(sgr.data, varname = "SGR", groupnames = c("Species", "Size", "Treatment", "Date"))

ggplot(sgr.data.summary, aes(x = Date, fill = Size, y = SGR))+
  geom_bar(stat = "identity", position = position_dodge(), na.rm = TRUE)+
  labs(y = expression(paste("SGR (", d^-1,")")))+
  scale_y_continuous(expand=c(0, 0), limits=c(-0.005, 0.025))+
  facet_grid(cols=vars(Treatment))+
  facet_wrap(~Species + Treatment, nrow = 4)+
  geom_errorbar(aes(ymin=SGR-(1*se), ymax=SGR+(1*se)), width=.2,
                position=position_dodge(.9))+
  scale_fill_manual(values=c("#adadad", "#7A7A7A", "#303030"))+
  theme_light()+
  theme(
    axis.text.x = element_text(size=12, angle = 90, vjust = 0.5, hjust=1)
  )
ggsave("All_SGR.tiff", width = 18, height = 24, units = "cm", dpi=1200, compression = "lzw")

## Simplify data by taking average SGR: ignore effect of time (bleaching event/seasons)
sgr.data <- subset(sgr.data, Date == "Average")

## Exclude columns not used
sgr.data <- sgr.data %>%
  select(-c("Length", "Cause_death", "Condition", "EV"))

## Get averages, split per Species, Size and Treatment
sgr.summary <- data_summary(sgr.data, varname = "SGR", groupnames = c("Species", "Size", "Treatment"))

# MODEL
## Random factor to account for non-independence of multiple coral fragments in same nursery Structure
### Full model without random factor
lme.sgr.0r  <- gls(SGR ~ Treatment*Species*Size, method = "REML", na.action = na.omit,
                  data = sgr.data) # AIC = -3369

### Full model with random factor
lme.sgr.1r  <- lme(SGR ~ Treatment*Species*Size, method = "REML", na.action = na.omit, random = ~1 | Structure, 
                  data = sgr.data) # AIC = -3378

AIC(lme.sgr.0r, lme.sgr.1r) # Tree as random factor improves model substantially and accounts for pseudo-replication

## Allowing for heterogeneity among Species (showed best residuals of all Species * Size * Treatment combis)
lme.sgr.1r.S  <- lme(SGR ~ Treatment*Species*Size, method = "ML", na.action = na.omit, random = ~1 | Structure, 
                  data = sgr.data, weights = varIdent(form = ~1 | Species))

## Model output
Anova(lme.sgr.1r.S) # Three-way interaction not significant, but all three 2-way interactions are

```
## Model validation
```{r SGR model validation}

mod <- lme.sgr.1r.S # set model to be validated
op <- par(mfrow = c(2, 4), mar = c(5, 4, 1, 2)) # set layout of figure frame
plot(resid(mod, type = "pearson") ~ fitted(mod)) # fitted vs residuals
abline(0,0)
hist(resid(mod, type = "pearson"), main = "") # histogram residuals
qqnorm(resid(mod, type = "pearson")) # QQplot residuals
plot(sgr.data$Treatment, resid(mod, type = "pearson")) # residuals split over Date
abline(0,0)
plot(sgr.data$Species, resid(mod, type = "pearson")) # residuals split over Treatment
abline(0,0)
plot(sgr.data$Size, resid(mod, type = "pearson")) # residuals split over Treatment
abline(0,0)
plot(fitted(mod) ~ sgr.data$SGR) # response data vs fitted
par(op)

```
## Post hoc and plots
```{r SGR plot}

# Size*Species plot
# Get averages
sgr.summary.SS <- data_summary(sgr.data, varname = "SGR", groupnames = c("Species", "Size"))
# Create unique Finder for each Species*Size combination
sgr.summary.SS <- as.data.frame(append(sgr.summary.SS,
    list(Finder = paste(sgr.summary.SS$Species, sgr.summary.SS$Size, sep=":")), after = 0))
# Create ID and order dataframe by name of Finder
sgr.summary.SS <- tibble::rownames_to_column(sgr.summary.SS, "ID")
sgr.summary.SS <- sgr.summary.SS[order(as.character(sgr.summary.SS$Finder)),]

# Perform post hoc and get significance letters (Compact Letter Display) between Sizes within each Species
hsd.SS <- emmeans(lme.sgr.1r.S, specs = pairwise ~ Size|Species, adjust = "tukey")
letters.SS <- multcomp::cld(hsd.SS$emmeans, reversed = TRUE, alpha = 0.05, Letters = letters) # get CLD

# Create ID and order dataframe by name (equals Finder of sgr.summary.SS dataframe)
letters.SS <- as.data.frame(append(letters.SS,
    list(Finder = paste(letters.SS$Species, letters.SS$Size, sep=":")), after = 0))
letters.SS <- letters.SS[order(letters.SS$Finder),]
letters.SS <- letters.SS %>% mutate(.group = str_squish(.group)) # remove white spaces

# Merge sig.letter dataframe into the summary dataframe
sgr.summary.SS <- cbind(sgr.summary.SS, siglet = letters.SS$.group)
sgr.summary.SS <- sgr.summary.SS[order(as.numeric(sgr.summary.SS$ID)),]

# Plot Size x Species
SGR_SpeciesxSize<- ggplot(sgr.summary.SS, aes(x = Species, fill = Size, y = SGR))+
  geom_bar(stat = "identity", position = position_dodge())+ 
  labs(y = expression(paste("SGR (", d^-1,")")), x = "Species")+
  scale_y_continuous(limits=c(0, 0.014), breaks = c(0, 0.005, 0.01), expand = c(0, 0))+
  geom_errorbar(aes(ymin=SGR-(1*se), ymax=SGR+(1*se)), width=.2, position=position_dodge(.9))+
  geom_text(data = sgr.summary.SS, aes(x=Species, y = SGR + se+0.0004, label = siglet),
            vjust=0, position = position_dodge(.9))+
  scale_fill_manual(values=c("#A9A9A9", "#7A7A7A", "#5A5A5A"))+
  theme_economist()+scale_colour_economist()+
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.title.y = element_text(color="black" , vjust=4, size = 12),
    axis.text.y=element_text(size=12, face = "bold", vjust=0.5),
    axis.ticks.length.x = unit(c(0,2), "mm")
    )+
scale_x_discrete(labels= c("A. cf muricata", "A. verweyi", "P. verrucosa", "P. cylindrica"))
#ggsave("SGR_Species x Size.tiff", width = 18, height = 8, units = "cm", dpi=1200, compression = "lzw")

# Treatment*Species plot
# Get averages
sgr.summary.TS <- data_summary(sgr.data, varname = "SGR", groupnames = c("Treatment", "Species"))
# Create unique Finder for each Treatment*Species combination
sgr.summary.TS <- as.data.frame(append(sgr.summary.TS,
    list(Finder = paste(sgr.summary.TS$Treatment, sgr.summary.TS$Species, sep=":")), after = 0))
# Create ID and order dataframe by name of Finder
sgr.summary.TS <- tibble::rownames_to_column(sgr.summary.TS, "ID")
sgr.summary.TS <- sgr.summary.TS[order(as.character(sgr.summary.TS$Finder)),]

# Perform post hoc and get significance letters (Compact Letter Display) between Sizes within each Species
hsd.TS <- emmeans(lme.sgr.1r.S, specs = pairwise ~ Treatment|Species, adjust = "tukey")
letters.TS <- multcomp::cld(hsd.TS$emmeans, decreasing = TRUE, alpha = 0.05, Letters = letters) # get CLD

# Create ID and order dataframe by name (equals Finder of sgr.summary.SS dataframe)
letters.TS <- as.data.frame(append(letters.TS,
    list(Finder = paste(letters.TS$Treatment, letters.TS$Species, sep=":")), after = 0))
letters.TS <- letters.TS[order(letters.TS$Finder),]
letters.TS <- letters.TS %>% mutate(.group = str_squish(.group)) # remove white spaces

# Merge sig.letter dataframe into the summary dataframe
sgr.summary.TS <- cbind(sgr.summary.TS, siglet = letters.TS$.group)
sgr.summary.TS <- sgr.summary.TS[order(as.numeric(sgr.summary.TS$ID)),]

# Plot Treatment x Species
SGR_TreatmentxSpecies <- ggplot(sgr.summary.TS, aes(x = Species, fill = Treatment, y = SGR))+
  geom_bar(stat = "identity", position = position_dodge())+ 
  labs(y = expression(paste("SGR (", d^-1,")")), x = "Species")+
  scale_y_continuous(limits=c(0, 0.012), breaks = c(0, 0.005, 0.01), expand = c(0, 0))+
  geom_errorbar(aes(ymin=SGR-(1*se), ymax=SGR+(1*se)), width=.2, position=position_dodge(.9))+
  geom_text(data = sgr.summary.TS, aes(x=Species, y = SGR + se+0.0004, label = siglet),
            vjust=0, position = position_dodge(.9))+
  scale_fill_manual(values=c("#A9A9A9", "#7A7A7A", "#5A5A5A", "#3A3A3A"))+
  theme_economist()+scale_colour_economist()+
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.title.y = element_text(color="black" , vjust=4, size = 12),
    axis.text.y=element_text(size=12, face = "bold", vjust=0.5),
    axis.ticks.length.x = unit(c(0,2), "mm")
    )+
scale_x_discrete(labels= c("A. cf muricata", "A. verweyi", "P. verrucosa", "P. cylindrica"))
#ggsave("SGR_Treatment x Species.tiff", width = 18, height = 8, units = "cm", dpi=1200, compression = "lzw")

# Treatment*Size plot
# Get averages
sgr.summary.TSi <- data_summary(sgr.data, varname = "SGR", groupnames = c("Treatment", "Size"))
# Create unique Finder for each Treatment*Size combination
sgr.summary.TSi <- as.data.frame(append(sgr.summary.TSi,
    list(Finder = paste(sgr.summary.TSi$Treatment, sgr.summary.TSi$Size, sep=":")), after = 0))
# Create ID and order dataframe by name of Finder
sgr.summary.TSi <- tibble::rownames_to_column(sgr.summary.TSi, "ID")
sgr.summary.TSi <- sgr.summary.TSi[order(as.character(sgr.summary.TSi$Finder)),]

# Perform post hoc and get significance letters (Compact Letter Display) between Sizes within each Species
hsd.TSi <- emmeans(lme.sgr.1r.S, specs = pairwise ~ Treatment|Size, adjust = "tukey")
letters.TSi <- multcomp::cld(hsd.TSi$emmeans, decreasing = TRUE, alpha = 0.05, Letters = letters) # get CLD

# Create ID and order dataframe by name (equals Finder of sgr.summary.SS dataframe)
letters.TSi <- as.data.frame(append(letters.TSi,
    list(Finder = paste(letters.TSi$Treatment, letters.TSi$Species, sep=":")), after = 0))
letters.TSi <- letters.TSi[order(letters.TSi$Finder),]
letters.TSi <- letters.TSi %>% mutate(.group = str_squish(.group)) # remove white spaces

# Merge sig.letter dataframe into the summary dataframe
sgr.summary.TSi <- cbind(sgr.summary.TSi, siglet = letters.TSi$.group)
sgr.summary.TSi <- sgr.summary.TSi[order(as.numeric(sgr.summary.TSi$ID)),]

# Plot Species*Size*Treatment bar graph + error bars + letters
SGR_TreatmentxSize <- ggplot(sgr.summary.TSi, aes(x = Size, fill = Treatment, y = SGR))+
  geom_bar(stat = "identity", position = position_dodge())+ 
  labs(y = expression(paste("SGR (", d^-1,")")), x = "Size")+
  scale_y_continuous(limits=c(0, 0.013), breaks = c(0, 0.005, 0.01), expand = c(0,0))+
  geom_errorbar(aes(ymin=SGR-(1*se), ymax=SGR+(1*se)), width=.2, position=position_dodge(.9))+
  geom_text(data = sgr.summary.TSi, aes(x=Size, y = SGR + se*2, label = siglet),
            vjust=0, position = position_dodge(.9))+
  scale_fill_manual(values=c("#A9A9A9", "#7A7A7A", "#5A5A5A", "#3A3A3A"))+
  theme_economist()+scale_colour_economist()+
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.title.y = element_text(color="black" , vjust=4, size = 12),
    axis.text.y=element_text(size=12, face = "bold", vjust=0.5),
    axis.ticks.length.x = unit(c(0,2), "mm")
    )+
scale_x_discrete(labels= c("Small", "Medium", "Large"))
#ggsave("SGR_Treatment x Size.tiff", width = 18, height = 8, units = "cm", dpi=1200, compression = "lzw")

# Treatment plot
# Get averages
sgr.summary.T <- data_summary(sgr.data, varname = "SGR", groupnames = c("Treatment"))
# Create ID and order dataframe
sgr.summary.T <- tibble::rownames_to_column(sgr.summary.T, "ID")
sgr.summary.T <- sgr.summary.T[order(as.character(sgr.summary.T$Treatment)),]

# Perform post hoc and get significance letters (Compact Letter Display) between Treatments within each Date
hsd.T <- emmeans(lme.sgr.1r.S, specs = pairwise ~ Treatment, adjust = "tukey")
letters.T <- multcomp::cld(hsd.T$emmeans, decreasing = TRUE, alpha = 0.05, Letters = letters) # get CLD
letters.T <- letters.T[order(as.character(letters.T$Treatment)),]
letters.T <- letters.T %>% mutate(.group = str_squish(.group)) # remove white spaces

# Merge sig.letter dataframe into the summary dataframe
sgr.summary.T <- cbind(sgr.summary.T, siglet = letters.T$.group)
sgr.summary.T <- sgr.summary.T[order(as.numeric(sgr.summary.T$ID)),]

# Plot Species*Size*Treatment bar graph + error bars + letters
ggplot(sgr.summary.T, aes(x = Treatment, y = SGR))+
  geom_bar(stat = "identity", position = position_dodge())+
  labs(y = expression(paste("SGR (", d^-1,")")), x = "Treatment")+
  scale_y_continuous(limits=c(0, 0.01), breaks = c(0, 0.005, 0.01))+
  geom_errorbar(aes(ymin=SGR-(1*se), ymax=SGR+(1*se)), width=.2, position=position_dodge(.9))+
  geom_text(data = sgr.summary.T, aes(x=Treatment, y = SGR + se*1.5, label = siglet), vjust=0,
                position=position_dodge(.9))+
  theme_economist()+scale_colour_economist()+
  theme(
    axis.title.x = element_text(color="black", vjust=-2, size = 12),
    axis.text.x=element_text(size=12, face = "bold", vjust=0.5),
    axis.title.y = element_text(color="black" , vjust=4, size = 12),
    axis.text.y=element_text(size=12, face = "bold", vjust=0.5)
    )
#ggsave("SGR_Treatment.tiff", width = 18, height = 8, units = "cm", dpi=1200, compression = "lzw")

```

# Survival analysis
## Data preparations
```{r data preparations}

# Create survival dataframe
surv.data <- clean.data.1

## Visualize time effect
surv.data.summary <- data_summary(surv.data, varname = "Condition", groupnames = c("Species", "Size", "Treatment", "Date"))
surv.data.summary <- subset(surv.data.summary, Date != "Average")

ggplot(surv.data.summary, aes(x = Date, fill = Size, y = Condition))+
  geom_bar(stat = "identity", position = position_dodge(), na.rm = TRUE)+
  labs(y = "Live tissue (%)")+
  scale_y_continuous(expand=c(0, 0), limits=c(0, 100))+
  facet_grid(cols=vars(Treatment))+
  facet_wrap(~Species + Treatment, nrow = 4)+
  geom_errorbar(aes(ymin=Condition-(1*se), ymax=Condition+(1*se)), width=.2,
                position=position_dodge(.9))+
  scale_fill_manual(values=c("#adadad", "#7A7A7A", "#303030"))+
  theme_light()+
  theme(
    axis.text.x = element_text(size=12, angle = 90, vjust = 0.5, hjust=1)
  )
ggsave("All_Survival.tiff", width = 18, height = 24, units = "cm", dpi=1200, compression = "lzw")

# Select survival at end of experiment only (ignore effect of time)
surv.data <- subset(surv.data, Date == "Average")

# Exclude columns not used
surv.data <- surv.data %>%
  select(-c("Length", "Cause_death", "SGR", "EV"))

# Get averages per structure, split per Species, Size and Treatment
surv.avg <- data_summary(surv.data, varname = "Condition", groupnames = c("Species", "Size", "Treatment", "Structure"))
surv.avg <- surv.avg %>% select(-c("sd", "se"))

```
## Model selection
<!--  
### Linear models (lm) couldn't be used: no data transformation could deal with this type of data
### Beta regression using full data set didn't work (hopeless residuals), so using data averaged over structures  
-->

### Averaged beta selection
```{r AVG survival: betareg model selection}

# DATA PREP
## Create dataset
surv.avg.1 <- surv.avg

## Transform survival (%) into fraction
surv.avg.1 <- surv.avg %>% mutate(Condition.f = Condition/100)

## Re-scale so there are no 0 and 1 in the dataset
surv.avg.1<- surv.avg.1 %>% 
  mutate(Condition.fc = (Condition.f * (length(Condition.f) - 1) + 0.5) / length(Condition.f))

## Set ID
surv.avg.1 <- tibble::rownames_to_column(surv.avg.1, "ID")

# MODEL
## Betareg full model
## Residuals could not be improved by variable precision nor bias correction
bm1 <- betareg(Condition.fc ~ Species*Size*Treatment, data = surv.avg.1)

## Model selection fixed part
car::Anova(bm1) # Three way interaction significant

```
## Model validation
```{r AVG survival: model validation}

mod <- bm1 # set model to be validated
op <- par(mfrow = c(2, 4), mar = c(5, 4, 1, 2)) # set layout of figure frame
plot(resid(mod, type = "pearson") ~ fitted(mod)) # fitted vs residuals
abline(0,0)
hist(resid(mod, type = "pearson"), main = "") # histogram residuals
qqnorm(resid(mod, type = "pearson")) # QQplot residuals
plot(surv.avg.1$Size, resid(mod, type = "pearson")) # residuals split over Date
abline(0,0)
plot(surv.avg.1$Species, resid(mod, type = "pearson")) # residuals split over Treatment
abline(0,0)
plot(surv.avg.1$Treatment, resid(mod, type = "pearson")) # residuals split over Treatment
abline(0,0)
plot(fitted(mod) ~ surv.avg.1$Condition.fc) # response data vs fitted
par(op)

```
## Post hoc and plots
```{r AVG survival: plots}

# Species * Size * Treatment plot
# Get averages
surv.summary.SST <- data_summary(surv.data, varname = "Condition", groupnames = c("Species", "Size", "Treatment"))
# Create unique Finder for each Species*Size*Treatment combination
surv.summary.SST <- as.data.frame(append(surv.summary.SST,
    list(Finder = paste(paste(surv.summary.SST$Species, surv.summary.SST$Size, sep=":"), surv.summary.SST$Treatment,
    sep=":")), after = 0))
# Create ID and order dataframe by name of Finder
surv.summary.SST <- tibble::rownames_to_column(surv.summary.SST, "ID")
surv.summary.SST <- surv.summary.SST[order(surv.summary.SST$Finder),]

# Post hoc comparison
hsd.surv.SST <- emmeans(bm1, specs = pairwise ~ Treatment | Species * Size, adjust = "tukey") 
sig.letters.surv.SST <- multcomp::cld(hsd.surv.SST$emmeans, alpha = 0.05, Letters = letters, decreasing = T) # get CLD

# Create ID and order dataframe by name (equals Finder of surv.summary.SST dataframe)
sig.letters.surv.SST <- tibble::rownames_to_column(sig.letters.surv.SST, "Group")
sig.letters.surv.SST <- as.data.frame(append(sig.letters.surv.SST,
     list(Finder = paste(paste(sig.letters.surv.SST$Species, sig.letters.surv.SST$Size, sep=":"), sig.letters.surv.SST$Treatment,
    sep=":")), after = 0))
sig.letters.surv.SST <- sig.letters.surv.SST[order(sig.letters.surv.SST$Finder),]
sig.letters.surv.SST <- sig.letters.surv.SST %>% mutate(.group = str_squish(.group)) # remove white spaces

# Merge sig.letter dataframe into the summary dataframe
surv.summary.SST <- cbind(surv.summary.SST, siglet = sig.letters.surv.SST$.group)
surv.summary.SST <- surv.summary.SST[order(as.numeric(surv.summary.SST$ID)),]

# Labels facet grip
spec.labs <- c("A. cf muricata", "A. verweyi", "P. verrucosa", "P. cylindrica")
names(spec.labs) <- c("Acropora cf muricata", "Acropora verweyi", "Pocillopora verrucosa", "Porites cylindrica")

# Plot Species*Size*Treatment bar graph + error bars + letters
ggplot(surv.summary.SST, aes(x = Size, fill = Treatment, y = Condition))+
  geom_bar(stat = "identity", position = position_dodge())+ 
  labs(y = "Live tissue (%)", x = "Size")+ facet_grid(rows=vars(Species), labeller = labeller(Species = spec.labs)) +
  geom_errorbar(aes(ymin=Condition-(1*se), ymax=Condition+(1*se)), width=.2,
                position=position_dodge(.9))+
  geom_text(data = surv.summary.SST, aes(x=Size, y = Condition + se+4, label = siglet), vjust=0,
                position=position_dodge(.9))+
  scale_fill_manual(values=c("#A9A9A9", "#7A7A7A", "#5A5A5A", "#3A3A3A"))+
  theme_economist()+scale_colour_economist()+
  theme(
    axis.title.x = element_text(color="black", vjust=-2, size = 12),
    axis.text.x = element_text(angle = 0, size=12, face = "bold.italic", vjust=0.5),
    axis.title.y = element_text(color="black" , vjust=4, size = 12),
    axis.text.y=element_text(size=12, face = "bold", vjust=0.5),
    strip.text.y = element_text(size = 12, face = "bold.italic")
    )+
scale_x_discrete(labels= c("Small", "Medium", "Large"))+
scale_y_continuous(breaks= c(0, 50, 100), limits = c(0,120))
ggsave("Survival(AVG)_Species x Size x Treatment.tiff", width = 18, height = 23, units = "cm", dpi=1200, compression = "lzw")

# Species * Treatment plot
# Get averages
surv.summary.TSp <- data_summary(surv.data, varname = "Condition", groupnames = c("Species", "Treatment"))
# Create unique Finder
surv.summary.TSp <- as.data.frame(append(surv.summary.TSp,
    list(Finder = paste(surv.summary.TSp$Species, surv.summary.TSp$Treatment, sep=":")), after = 0))
# Create ID and order dataframe by name of Finder
surv.summary.TSp <- tibble::rownames_to_column(surv.summary.TSp, "ID")
surv.summary.TSp <- surv.summary.TSp[order(surv.summary.TSp$Finder),]

# Post hoc comparison
hsd.surv.TSp <- emmeans(bm1, specs = pairwise ~ Treatment|Species, adjust = "tukey") 
sig.letters.surv.TSp <- multcomp::cld(hsd.surv.TSp$emmeans, alpha = 0.05, Letters = letters, decreasing = T) # get CLD

# Create ID and order dataframe by name (equals Finder of sgr.summary.SST dataframe)
sig.letters.surv.TSp <- tibble::rownames_to_column(sig.letters.surv.TSp, "Group")
sig.letters.surv.TSp <- as.data.frame(append(sig.letters.surv.TSp,
    list(Finder = paste(sig.letters.surv.TSp$Species, sig.letters.surv.TSp$Treatment, sep=":")), after = 0))
sig.letters.surv.TSp <- sig.letters.surv.TSp[order(sig.letters.surv.TSp$Finder),]
sig.letters.surv.TSp <- sig.letters.surv.TSp %>% mutate(.group = str_squish(.group)) # remove white spaces

# Merge sig.letter dataframe into the summary dataframe
surv.summary.TSp <- cbind(surv.summary.TSp, siglet = sig.letters.surv.TSp$.group)
surv.summary.TSp <- surv.summary.TSp[order(as.numeric(surv.summary.TSp$ID)),]

# Plot Species*Treatment bar graph + error bars + letters
Survival_TreatmentxSpecies <- ggplot(surv.summary.TSp, aes(x = Species, fill = Treatment, y = Condition))+
  geom_bar(stat = "identity", position = position_dodge())+ 
  labs(y = "Live tissue (%)", x = "Species")+
  geom_errorbar(aes(ymin=Condition-(1*se), ymax=Condition+(1*se)), width=.2,
                position=position_dodge(.9))+
  geom_text(data = surv.summary.TSp, aes(x=Species, y = Condition + se+4, label = siglet), vjust=0,
                position=position_dodge(.9))+
  scale_fill_manual(values=c("#A9A9A9", "#7A7A7A", "#5A5A5A", "#3A3A3A"))+
  theme_economist()+scale_colour_economist()+
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.title.y = element_text(color="black" , vjust=4, size = 12),
    axis.text.y=element_text(size=12, face = "bold", vjust=0.5),
    legend.position="none",
    axis.ticks.length.x = unit(c(0,2), "mm")
    )+
scale_x_discrete(labels= c("A. cf muricata", "A. verweyi", "P. verrucosa", "P. cylindrica"))+
scale_y_continuous(breaks= c(0, 50, 100), limits = c(0, 115), expand = c(0, 0))
#ggsave("Survival(AVG)_Species x Treatment.tiff", width = 18, height = 8, units = "cm", dpi=1200, compression = "lzw")

# Size * Treatment plot
# Get averages
surv.summary.TSi <- data_summary(surv.data, varname = "Condition", groupnames = c("Size", "Treatment"))
# Create unique Finder
surv.summary.TSi <- as.data.frame(append(surv.summary.TSi,
    list(Finder = paste(surv.summary.TSi$Size, surv.summary.TSi$Treatment, sep=":")), after = 0))
# Create ID and order dataframe by name of Finder
surv.summary.TSi <- tibble::rownames_to_column(surv.summary.TSi, "ID")
surv.summary.TSi <- surv.summary.TSi[order(surv.summary.TSi$Finder),]

# Post hoc comparison
hsd.surv.TSi <- emmeans(bm1, specs = pairwise ~ Treatment|Size, adjust = "tukey") 
sig.letters.surv.TSi <- multcomp::cld(hsd.surv.TSi$emmeans, alpha = 0.05, Letters = letters, decreasing = T)

# Create ID and order dataframe by name (equals Finder of sgr.summary.SST dataframe)
sig.letters.surv.TSi <- tibble::rownames_to_column(sig.letters.surv.TSi, "Group")
sig.letters.surv.TSi <- as.data.frame(append(sig.letters.surv.TSi,
    list(Finder = paste(sig.letters.surv.TSi$Size, sig.letters.surv.TSi$Treatment, sep=":")), after = 0))
sig.letters.surv.TSi <- sig.letters.surv.TSi[order(sig.letters.surv.TSi$Finder),]
sig.letters.surv.TSi <- sig.letters.surv.TSi %>% mutate(.group = str_squish(.group)) # remove white spaces

# Merge sig.letter dataframe into the summary dataframe
surv.summary.TSi <- cbind(surv.summary.TSi, siglet = sig.letters.surv.TSi$.group)
surv.summary.TSi <- surv.summary.TSi[order(as.numeric(surv.summary.TSi$ID)),]

# Plot Species*Treatment bar graph + error bars + letters
Survival_TreatmentxSize <- ggplot(surv.summary.TSi, aes(x = Size, fill = Treatment, y = Condition))+
  geom_bar(stat = "identity", position = position_dodge())+ 
  labs(y = "Live tissue (%)", x = "Size")+
  geom_errorbar(aes(ymin=Condition-(1*se), ymax=Condition+(1*se)), width=.2,
                position=position_dodge(.9))+
  geom_text(data = surv.summary.TSi, aes(x=Size, y = Condition + se+4, label = siglet), vjust=0,
                position=position_dodge(.9))+
  scale_fill_manual(values=c("#A9A9A9", "#7A7A7A", "#5A5A5A", "#3A3A3A"))+
  theme_economist()+scale_colour_economist()+
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.title.y = element_text(color="black" , vjust=4, size = 12),
    axis.text.y=element_text(size=12, face = "bold", vjust=0.5),
    legend.position="none",
    axis.ticks.length.x = unit(c(0,2), "mm")
    )+
scale_x_discrete(labels= c("Small", "Medium", "Large"))+
scale_y_continuous(breaks= c(0, 50, 100), limits = c(0, 115), expand = c(0,0))
#ggsave("Survival(AVG)_Size x Treatment.tiff", width = 18, height = 8, units = "cm", dpi=1200, compression = "lzw")

# Species x Size plot
# Get averages
surv.summary.SS <- data_summary(surv.data, varname = "Condition", groupnames = c("Size", "Species"))
# Create unique Finder
surv.summary.SS <- as.data.frame(append(surv.summary.SS,
    list(Finder = paste(surv.summary.SS$Size, surv.summary.SS$Species, sep=":")), after = 0))
# Create ID and order dataframe by name of Finder
surv.summary.SS <- tibble::rownames_to_column(surv.summary.SS, "ID")
surv.summary.SS <- surv.summary.SS[order(surv.summary.SS$Finder),]

# Post hoc comparison
hsd.surv.SS <- emmeans(bm1, specs = pairwise ~ Size|Species, adjust = "tukey") 
sig.letters.surv.SS <- multcomp::cld(hsd.surv.SS$emmeans, alpha = 0.05, Letters = letters, decreasing = T)

# Create ID and order dataframe by name (equals Finder of sgr.summary.SST dataframe)
sig.letters.surv.SS <- tibble::rownames_to_column(sig.letters.surv.SS, "Group")
sig.letters.surv.SS <- as.data.frame(append(sig.letters.surv.SS,
    list(Finder = paste(sig.letters.surv.SS$Size, sig.letters.surv.SS$Species, sep=":")), after = 0))
sig.letters.surv.SS <- sig.letters.surv.SS[order(sig.letters.surv.SS$Finder),]
sig.letters.surv.SS <- sig.letters.surv.SS %>% mutate(.group = str_squish(.group)) # remove white spaces

# Merge sig.letter dataframe into the summary dataframe
surv.summary.SS <- cbind(surv.summary.SS, siglet = sig.letters.surv.SS$.group)
surv.summary.SS <- surv.summary.SS[order(as.numeric(surv.summary.SS$ID)),]

# Plot Species x Size
Survival_SpeciesxSize <- ggplot(surv.summary.SS, aes(x = Species, fill = Size, y = Condition))+
  geom_bar(stat = "identity", position = position_dodge())+ 
  labs(y = "Live tissue (%)", x = "Size")+
  geom_errorbar(aes(ymin=Condition-(1*se), ymax=Condition+(1*se)), width=.2,
                position=position_dodge(.9))+
  geom_text(data = surv.summary.SS, aes(x=Species, y = Condition + se+4, label = siglet), vjust=0,
                position=position_dodge(.9))+
  scale_fill_manual(values=c("#A9A9A9", "#7A7A7A", "#5A5A5A"))+
  theme_economist()+scale_colour_economist()+
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.title.y = element_text(color="black" , vjust=4, size = 12),
    axis.text.y=element_text(size=12, face = "bold", vjust=0.5),
    axis.ticks.length.x = unit(c(0,2), "mm"),
    legend.position="none"
    )+
scale_x_discrete(labels= c("A. cf muricata", "A. verweyi", "P. verrucosa", "P. cylindrica"))+
scale_y_continuous(breaks= c(0, 50, 100), expand = c(0, 0), limits =c(0, 115))
#ggsave("Survival(AVG)_Species x Size.tiff", width = 18, height = 8, units = "cm", dpi=1200, compression = "lzw")

# Treatment plot (ignoring interactions)
# Get averages
surv.summary.T <- data_summary(surv.data, varname = "Condition", groupnames = c("Treatment"))

# Create ID and order dataframe by name of Finder
surv.summary.T <- tibble::rownames_to_column(surv.summary.T, "ID")
surv.summary.T <- surv.summary.T[order(as.character(surv.summary.T$Treatment)),]

# Post hoc comparison
hsd.surv.T <- emmeans(bm1, specs = pairwise ~ Treatment, adjust = "tukey") 
sig.letters.surv.T <- multcomp::cld(hsd.surv.T$emmeans, alpha = 0.05, Letters = letters, decreasing = T)

# Create ID and order dataframe by name (equals Finder of sgr.summary.SST dataframe)
sig.letters.surv.T <- sig.letters.surv.T[order(as.character(sig.letters.surv.T$Treatment)),]
sig.letters.surv.T <- sig.letters.surv.T %>% mutate(.group = str_squish(.group)) # remove white spaces

# Merge sig.letter dataframe into the summary dataframe
surv.summary.T <- cbind(surv.summary.T, siglet = sig.letters.surv.T$.group)
surv.summary.T <- surv.summary.T[order(as.numeric(surv.summary.T$ID)),]

# Plot Species*Treatment bar graph + error bars + letters
ggplot(surv.summary.T, aes(x = Treatment, y = Condition))+
  geom_bar(stat = "identity", position = position_dodge())+ 
  labs(y = "Survival (%)", x = "Treatment")+
  geom_errorbar(aes(ymin=Condition-(1*se), ymax=Condition+(1*se)), width=.2,
                position=position_dodge(.9))+
  geom_text(data = surv.summary.T, aes(x=Treatment, y = Condition + se+4, label = siglet), vjust=0,
                position=position_dodge(.9))+
  theme_economist()+scale_colour_economist()+
  theme(
    axis.title.x = element_text(color="black", vjust=-2, size = 12),
    axis.text.x = element_text(angle = 0, size=12, face = "bold", vjust=0.5),
    axis.title.y = element_text(color="black" , vjust=4, size = 12),
    axis.text.y=element_text(size=12, face = "bold", vjust=0.5)
    )+
scale_x_discrete(labels= c("Weekly", "Monthly", "Quarterly", "Never"))+
scale_y_continuous(breaks= c(0, 25, 50, 75, 100))
#ggsave("Survival(AVG)_Treatment.tiff", width = 18, height = 8, units = "cm", dpi=1200, compression = "lzw")

```

# Production analysis
## Log-link model
```{r Production: Log-link model selection}

# DATA PREP
## Create subset for Production data
P.data <- clean.data.1 %>% select(-c("Length", "Cause_death", "Condition", "SGR"))
P.data[is.na(P.data)] <- -100 # Set fragments that died to -100% volume increase
P.data <- subset(P.data, Date == "Average") ## Focus on percentage increase in EV over whole study period
colnames(P.data)[which(names(P.data) == "EV")] <- "EV.increase"

# MODEL
## Random factor to account for non-independence of fragments within same nursery Structure
### Full model without random factor
lm.p.1nr  <- gls(EV.increase ~ Species*Size*Treatment, method = "REML", data = P.data) # AIC = 8438

### Full model with random factor
lm.p.1  <- lme(EV.increase ~ Species*Size*Treatment, method = "REML", random = ~1 | Structure, 
               data = P.data) # AIC = 8437

AIC(lm.p.1nr, lm.p.1) # Tree as random factor improves model substantially and solves pseudo-replication

## Heterogeneity

## SQRT transformation of response variable to improve residuals
### To prevent negatives: add 100% to all (ie go from EV percentage increase to multiplication of EV)
P.data$EV.increase <- P.data$EV.increase + 100

## Allowing for heterogeneity ( choices based on residual plots)
lm.p.5  <- lme(sqrt(EV.increase) ~ Species*Size*Treatment, random = ~1 | Structure, method = "ML",
                  data = P.data)
lm.p.6 <- lme(sqrt(EV.increase) ~ Treatment*Species*Size, method = "ML", random = ~1 | Structure, 
                  data = P.data, weights = varIdent(form = ~1 | Size))
lm.p.7 <- lme(sqrt(EV.increase) ~ Treatment*Species*Size, method = "ML", random = ~1 | Structure, 
                  data = P.data, weights = varIdent(form = ~1 | Species))
lm.p.8 <- lme(sqrt(EV.increase) ~ Treatment*Species*Size, method = "ML", random = ~1 | Structure, 
                  data = P.data, weights = varIdent(form = ~1 | Treatment))
lm.p.9 <- lme(sqrt(EV.increase) ~ Treatment*Species*Size, method = "ML", random = ~1 | Structure, 
                  data = P.data, weights = varIdent(form = ~1 | Treatment*Size))
lm.p.10 <- lme(sqrt(EV.increase) ~ Treatment*Species*Size, method = "ML", random = ~1 | Structure, 
                  data = P.data, weights = varIdent(form = ~1 | Treatment*Species))
lm.p.11 <- lme(sqrt(EV.increase) ~ Treatment*Species*Size, method = "ML", random = ~1 | Structure, 
                  data = P.data, weights = varIdent(form = ~1 | Size*Species))

# lm.p.11 shows low AIC and shows best residuals
AIC(lm.p.5, lm.p.6, lm.p.7, lm.p.8, lm.p.9, lm.p.10, lm.p.11)

# Model selection
anova(lm.p.11) # Three-way interaction not significant, but Species*Size is

```
## Model validation
```{r Production: Log-link model validation}

mod <- lm.p.11
op <- par(mfrow = c(2, 4), mar = c(5, 4, 1, 2))
plot(resid(mod, type = "pearson") ~ fitted(mod))
abline(0,0)
plot(log10(P.data$EV.increase), resid(mod, type = "pearson"))
abline(0,0)
hist(resid(mod, type = "pearson"), main = "")
qqnorm(resid(mod, type = "pearson"))
plot(P.data$Size, resid(mod, type = "pearson"))
abline(0,0)
plot(P.data$Species, resid(mod, type = "pearson"))
abline(0,0)
plot(P.data$Treatment, resid(mod, type = "pearson"))
abline(0,0)
plot(fitted(mod) ~ log10(P.data$EV.increase))
par(op)

```
## Post hoc and plots
```{r Production: Log-link model plot}

# Size*Species plot
# Get averages
P.summary.SS <- data_summary(P.data, varname = "EV.increase", groupnames = c("Species", "Size"))

# Create unique Finder for each Species*Size combination
P.summary.SS <- as.data.frame(append(P.summary.SS,
    list(Finder = paste(P.summary.SS$Species, P.summary.SS$Size, sep=":")), after = 0))
# Create ID and order dataframe by name of Finder
P.summary.SS <- tibble::rownames_to_column(P.summary.SS, "ID")
P.summary.SS <- P.summary.SS[order(as.character(P.summary.SS$Finder)),]

# Perform post hoc and get significance letters (Compact Letter Display) between Sizes within each Species
hsd.P.SS <- emmeans(lm.p.11, specs = pairwise ~ Size|Species, adjust = "tukey")
sig.letters.P.SS <- multcomp::cld(hsd.P.SS$emmeans, decreasing = TRUE, alpha = 0.05, Letters = letters) # get CLD

# Create ID and order dataframe by name (equals Finder of sgr.summary.SS dataframe)
sig.letters.P.SS <- as.data.frame(append(sig.letters.P.SS,
    list(Finder = paste(sig.letters.P.SS$Species, sig.letters.P.SS$Size, sep=":")), after = 0))
sig.letters.P.SS <- sig.letters.P.SS[order(sig.letters.P.SS$Finder),]
sig.letters.P.SS <- sig.letters.P.SS %>% mutate(.group = str_squish(.group)) # remove white spaces

# Merge sig.letter dataframe into the summary dataframe
P.summary.SS <- cbind(P.summary.SS, siglet = sig.letters.P.SS$.group)
P.summary.SS <- P.summary.SS[order(as.numeric(P.summary.SS$ID)),]

# Plot Species*Size
EV_SpeciesxSize <- ggplot(P.summary.SS, aes(x = Species, fill = Size, y = EV.increase))+
  geom_bar(stat = "identity", position = position_dodge())+ 
  labs(y = "EV increase (%)", x = "Species")+
  scale_y_continuous(expand = c(0, 0), breaks = c(0, 3000, 6000), limits = c(0, 9000))+
  geom_errorbar(aes(ymin=EV.increase-(1*se), ymax=EV.increase+(1*se)), width=.2, position=position_dodge(.9))+
  geom_text(data = P.summary.SS, aes(x=Species, y = EV.increase + se+200, label = siglet),
            vjust=0, position = position_dodge(.9))+
  scale_fill_manual(values=c("#A9A9A9", "#7A7A7A", "#5A5A5A"))+
  theme_economist()+scale_colour_economist()+
  theme(
    axis.title.x = element_text(color="black", vjust=-2, size = 12),
    axis.text.x = element_text(angle = 0, size=12, face = "bold.italic", vjust=0.5),
    axis.title.y = element_text(color="black" , vjust=4, size = 12),
    axis.text.y=element_text(size=12, face = "bold", vjust=0.5),
    legend.position="none",
    axis.ticks.length.x = unit(c(0,2), "mm")
    )+
scale_x_discrete(labels= c("A. cf muricata", "A. verweyi", "P. verrucosa", "P. cylindrica"))
#ggsave("Production(LOG)_Species x Size.tiff", width = 18, height = 8, units = "cm", dpi=1200, compression = "lzw")

# Treatment*Species plot
# Get averages
P.summary.TS <- data_summary(P.data, varname = "EV.increase", groupnames = c("Species", "Treatment"))

# Create unique Finder for each Species*Size combination
P.summary.TS <- as.data.frame(append(P.summary.TS,
    list(Finder = paste(P.summary.TS$Species, P.summary.TS$Treatment, sep=":")), after = 0))
# Create ID and order dataframe by name of Finder
P.summary.TS <- tibble::rownames_to_column(P.summary.TS, "ID")
P.summary.TS <- P.summary.TS[order(as.character(P.summary.TS$Finder)),]

# Perform post hoc and get significance letters (Compact Letter Display) between Sizes within each Species
hsd.P.TS <- emmeans(lm.p.11, specs = pairwise ~ Treatment|Species, adjust = "tukey")
sig.letters.P.TS <- multcomp::cld(hsd.P.TS$emmeans, decreasing = TRUE, alpha = 0.05, Letters = letters) # get CLD

# Create ID and order dataframe by name (equals Finder of sgr.summary.SS dataframe)
sig.letters.P.TS <- as.data.frame(append(sig.letters.P.TS,
    list(Finder = paste(sig.letters.P.TS$Species, sig.letters.P.TS$Treatment, sep=":")), after = 0))
sig.letters.P.TS <- sig.letters.P.TS[order(sig.letters.P.TS$Finder),]
sig.letters.P.TS <- sig.letters.P.TS %>% mutate(.group = str_squish(.group)) # remove white spaces

# Merge sig.letter dataframe into the summary dataframe
P.summary.TS <- cbind(P.summary.TS, siglet = sig.letters.P.TS$.group)
P.summary.TS <- P.summary.TS[order(as.numeric(P.summary.TS$ID)),]

# Plot Species*Size bar graph + error bars + letters
EV_TreatmentxSpecies <- ggplot(P.summary.TS, aes(x = Species, fill = Treatment, y = EV.increase))+
  geom_bar(stat = "identity", position = position_dodge())+ 
  labs(y = "EV increase (%)", x = "Species")+
  scale_y_continuous(expand = c(0, 0), breaks = c(0, 3000, 6000), limits = c(0, 8000))+
  geom_errorbar(aes(ymin=EV.increase-(1*se), ymax=EV.increase+(1*se)), width=.2, position=position_dodge(.9))+
  geom_text(data = P.summary.TS, aes(x=Species, y = EV.increase + se+200, label = siglet),
            vjust=0, position = position_dodge(.9))+
  scale_fill_manual(values=c("#A9A9A9", "#7A7A7A", "#5A5A5A", "#3A3A3A"))+
  theme_economist()+scale_colour_economist()+
  theme(
    axis.title.x = element_text(color="black", vjust=-2, size = 12),
    axis.text.x = element_text(angle = 0, size=12, face = "bold.italic", vjust=0.5),
    axis.title.y = element_text(color="black" , vjust=4, size = 12),
    axis.text.y=element_text(size=12, face = "bold", vjust=0.5),
    legend.position="none",
    axis.ticks.length.x = unit(c(0,2), "mm")
    )+
scale_x_discrete(labels= c("A. cf muricata", "A. verweyi", "P. verrucosa", "P. cylindrica"))
#ggsave("Production(LOG)_Species x Treatment.tiff", width = 18, height = 8, units = "cm", dpi=1200, compression = "lzw")

# Treatment x Size
# Get averages
P.summary.TSI <- data_summary(P.data, varname = "EV.increase", groupnames = c("Treatment", "Size"))

# Create unique Finder for each Species*Size combination
P.summary.TSI <- as.data.frame(append(P.summary.TSI,
    list(Finder = paste(P.summary.TSI$Treatment, P.summary.TSI$Size, sep=":")), after = 0))
# Create ID and order dataframe by name of Finder
P.summary.TSI <- tibble::rownames_to_column(P.summary.TSI, "ID")
P.summary.TSI <- P.summary.TSI[order(as.character(P.summary.TSI$Finder)),]

# Perform post hoc and get significance letters (Compact Letter Display) between Sizes within each Species
hsd.P.TSI <- emmeans(lm.p.11, specs = pairwise ~ Treatment|Size, adjust = "tukey")
sig.letters.P.TSI <- multcomp::cld(hsd.P.TSI$emmeans, decreasing = TRUE, alpha = 0.05, Letters = letters) # get CLD

# Create ID and order dataframe by name (equals Finder of sgr.summary.SS dataframe)
sig.letters.P.TSI <- as.data.frame(append(sig.letters.P.TSI,
    list(Finder = paste(sig.letters.P.TSI$Treatment, sig.letters.P.TSI$Size, sep=":")), after = 0))
sig.letters.P.TSI <- sig.letters.P.TSI[order(sig.letters.P.TSI$Finder),]
sig.letters.P.TSI <- sig.letters.P.TSI %>% mutate(.group = str_squish(.group)) # remove white spaces

# Merge sig.letter dataframe into the summary dataframe
P.summary.TSI <- cbind(P.summary.TSI, siglet = sig.letters.P.TSI$.group)
P.summary.TSI <- P.summary.TSI[order(as.numeric(P.summary.TSI$ID)),]

# Plot Treatment*Size
EV_TreatmentxSize <- ggplot(P.summary.TSI, aes(x = Size, fill = Treatment, y = EV.increase))+
  geom_bar(stat = "identity", position = position_dodge())+ 
  labs(y = "EV increase (%)", x = "Size")+
  scale_y_continuous(expand = c(0, 0), breaks = c(0, 3000, 6000), limits = c(0, 6500))+
  geom_errorbar(aes(ymin=EV.increase-(1*se), ymax=EV.increase+(1*se)), width=.2, position=position_dodge(.9))+
  geom_text(data = P.summary.TSI, aes(x=Size, y = EV.increase + se+200, label = siglet),
            vjust=0, position = position_dodge(.9))+
  scale_fill_manual(values=c("#A9A9A9", "#7A7A7A", "#5A5A5A", "#3A3A3A"))+
  theme_economist()+scale_colour_economist()+
  theme(
    axis.title.x = element_text(color="black", vjust=-2, size = 12),
    axis.text.x = element_text(angle = 0, size=12, face = "bold.italic", vjust=0.5),
    axis.title.y = element_text(color="black" , vjust=4, size = 12),
    axis.text.y=element_text(size=12, face = "bold", vjust=0.5),
    legend.position="none",
    axis.ticks.length.x = unit(c(0,2), "mm")
    )
#ggsave("Production(LOG)_Treatment x Size.tiff", width = 18, height = 8, units = "cm", dpi=1200, compression = "lzw")

# Treatment plot
# Get averages
P.summary.T <- data_summary(P.data, varname = "EV.increase", groupnames = c("Treatment"))

# Create ID and order dataframe by name of Finder
P.summary.T <- P.summary.T[order(as.character(P.summary.T$Treatment)),]

# Post hoc comparison
hsd.P.T <- emmeans(lm.p.11, specs = pairwise ~ Treatment, adjust = "tukey", type = "response") 
sig.letters.P.T <- multcomp::cld(hsd.P.T$emmeans, alpha = 0.05, Letters = letters, decreasing = T)

# Create ID and order dataframe by name (equals Finder of sgr.summary.SST dataframe)
sig.letters.P.T <- sig.letters.P.T[order(as.character(sig.letters.P.T$Treatment)),]
sig.letters.P.T <- sig.letters.P.T %>% mutate(.group = str_squish(.group)) # remove white spaces

# Merge sig.letter dataframe into the summary dataframe
P.summary.T <- cbind(P.summary.T, siglet = sig.letters.P.T$.group)
P.summary.T <- tibble::rownames_to_column(P.summary.T, "ID")
P.summary.T <- P.summary.T[order(as.numeric(P.summary.T$ID)),]

# Plot Species*Treatment bar graph + error bars + letters
ggplot(P.summary.T, aes(x = Treatment, y = EV.increase))+
  geom_bar(stat = "identity", position = position_dodge())+ 
  labs(y = "EV increase (%)", x = "Treatment")+
  geom_errorbar(aes(ymin=EV.increase-(1*se), ymax=EV.increase+(1*se)), width=.2,
                position=position_dodge(.9))+
  geom_text(data = P.summary.T, aes(x=Treatment, y = EV.increase + se+100, label = siglet), vjust=0,
                position=position_dodge(.9))+
  theme_economist()+scale_colour_economist()+
  theme(
    axis.title.x = element_text(color="black", vjust=-2, size = 12),
    axis.text.x = element_text(angle = 0, size=12, face = "bold", vjust=0.5),
    axis.title.y = element_text(color="black" , vjust=4, size = 12),
    axis.text.y=element_text(size=12, face = "bold", vjust=0.5)
    )+
scale_x_discrete(labels= c("Weekly", "Monthly", "Quarterly", "Never"))
#ggsave("Production(LOG)_Treatment.tiff", width = 18, height = 8, units = "cm", dpi=1200, compression = "lzw")

```

```{r Production: costs}

# Costs per treatment
P.costs <- P.summary.TS[,c(1,3,4,5)]

# Calculate duration for each Treatment to reach 4000% increase (40x initial fragment size)
## Using average values across the three Sizes
## By combining formula of SGR = LN(EV_t/EV_0)/t_nursery and EV_end = EV_start * e^SGR*t_needed:
## t_needed = LN(EV_end/EV_start)/(LN(EV_t/EV_0)/t_nursery
## Where EV_t and EV_0 are realized start and end volumes per treatment, and EV_start and EV_end are the desired start and end volumes for which the nursery duration will be calculated, t_needed is days needed for fragment to reach desired end volume and t_nursery is days actual fragments were in the nursery (365)
## All volumes are expressed as multiplication factor in percentages, eg EV increase of 100% means fragments remained same size and EV increase of 200% means the volume doubled
P.costs <- P.costs %>% mutate(Days = log((4000)/100)/(log((EV.increase)/100)/365))

# Calculate cleaning costs (number of times cleaning * costs)
P.costs$Interval <- ifelse(P.costs$Treatment == "Weekly", 7,
                    ifelse(P.costs$Treatment == "Monthly", 30,
                    ifelse(P.costs$Treatment == "Quarterly", 91,  
                    ifelse(P.costs$Treatment == "Never", 0, 999 ))))
P.costs <- P.costs %>% mutate(Cleaning.visits = Days/Interval) # Number of cleaning visits per growth cycle (y)
P.costs$Cleaning.visits[P.costs$Treatment == "Never"] <- 0 # No cleaning for Never cleaning Treatment
P.costs <- P.costs %>% mutate(Trees.cleaned = c(5,4,3, 1)) # Trees cleaned in one visit (less when dirtier)

# 20 EUR for construction costs (materials + wage (8h)) divided by life span (5 cycles = 5 years) + deployment diving + wages (8h construction per tree, 2 divers * 3.5 h deployment for 3 trees)
dive.cost <- 20 # 15 EUR per dive per diver
material.cost <- 18.93 # Cement, PVC, loops etc
hour.wage <- 0.60 # 500 ksh for a 7h day
initial.cost.structure <- (material.cost/5) + ((hour.wage*8)/5) 
initial.costs.deployment <- ((dive.cost*2)/3) + ((hour.wage * 3.5 * 2) / 3)

P.costs <- P.costs %>% 
  mutate(Costs_1 = Cleaning.visits*(dive.cost/Trees.cleaned) + Cleaning.visits*(hour.wage*2/Trees.cleaned))
P.costs$Costs_structure <- (initial.cost.structure * P.costs$Days)/ (365*5)
P.costs$Costs_deployment <- initial.costs.deployment

P.costs <- add_column(P.costs, Costs_tot = P.costs$Costs_1 + P.costs$Costs_structure + P.costs$Costs_deployment, .after = 2)
P.costs$Costs_2 <- P.costs$Costs_structure + P.costs$Costs_deployment
P.costs <- select(P.costs, -c("Costs_structure", "Costs_deployment"))

P.costs <- as.data.frame(long_panel(P.costs, prefix = "_", begin = 1, end = 2, label_location = "end"))
colnames(P.costs)[which(names(P.costs) == "wave")] <- "Cost type"
P.costs$`Cost type` <- ifelse(P.costs$`Cost type` == 1, "Cleaning", "Maintenance")
P.costs$Costs_tot <- as.numeric(ifelse(P.costs$`Cost type` == "Cleaning", P.costs$Costs_tot, ""))

# Calculate per fragment (60 fragments in 1 tree)
P.costs <- P.costs %>% mutate(Costs.fragment = Costs/60) 
P.costs <- P.costs %>% mutate(Costs_tot = Costs_tot/60)


# Plot
scaleFUN <- function(x) sprintf("%.2f", x) # Get two decimals on y-axis

ggplot(P.costs, aes(x = Treatment, y = Costs.fragment, fill = `Cost type`))+
  geom_bar(position = "stack", stat="identity")+
  facet_wrap(~Species, nrow = 4, strip.position = "right")+
  labs(y = "Cost per fragment (EUR)",
       x = "Cleaning treatment")+
  scale_y_continuous(limits=c(0, 7), labels=scaleFUN)+
  theme_economist()+scale_colour_economist()+
  scale_fill_manual(values=c("#A9A9A9", "#3A3A3A"))+
  theme(
    axis.title.x = element_text(color="black", vjust=-2, size = 12),
    axis.text.x=element_text(size=12, face = "bold", vjust=0.5),
    axis.title.y = element_text(color="black" , vjust=4, size = 12),
    axis.text.y=element_text(size=11, vjust=0.5),
    strip.text.y = element_text(size = 12, face = "bold.italic")
    )+ 
  geom_text(aes(label = ifelse(is.na(Costs_tot), "", paste("€",  round(Costs_tot, 2)))), vjust = -1.2, size = 5, color="black", fontface = "bold")
ggsave("Cost per fragment.tiff", width = 18, height = 23, units = "cm", dpi=1200, compression = "lzw")

```

# Compile figs
```{r compile}

# Treatment x Species
SGR_Survival_EV_TreatmentxSpecies <- plot_grid(SGR_TreatmentxSpecies, Survival_TreatmentxSpecies, EV_TreatmentxSpecies, nrow = 3, align = "v", rel_heights = c(1.25, 1, 1.25),
                 labels = c("A", "B", "C"), label_size = 18)
ggsave("SGR_Survival_EV_TreatmentxSpecies.tiff", width = 18, height = 24, units = "cm", dpi=1200, compression = "lzw", SGR_Survival_EV_TreatmentxSpecies)

# Species x Size
SGR_Survival_EV_SpeciesxSize <- plot_grid(SGR_SpeciesxSize, Survival_SpeciesxSize, EV_SpeciesxSize, nrow = 3, align = "v", rel_heights = c(1.25, 1, 1.25),
                 labels = c("A", "B", "C"), label_size = 18)
ggsave("SGR_Survival_EV_SpeciesxSize.tiff", width = 18, height = 24, units = "cm", dpi=1200, compression = "lzw", SGR_Survival_EV_SpeciesxSize)

# Treatment x Size
SGR_Survival_EV_TreatmentxSize <- plot_grid(SGR_TreatmentxSize, Survival_TreatmentxSize, EV_TreatmentxSize,
                 nrow = 3, align = "v", rel_heights = c(1.25, 1, 1.25), labels = c("A", "B", "C"), label_size = 18)
ggsave("SGR_Survival_EV_TreatmentxSize.tiff", width = 18, height = 24, units = "cm", dpi=1200, compression = "lzw", SGR_Survival_EV_TreatmentxSize)


```


# Check packages used
```{r}

knitr::purl("Clean.Rmd")
list.functions.in.file("Clean.R")
unlink("Clean.R")

```



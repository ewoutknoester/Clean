---
title: "Clean"
author: "Ewout Knoester"
date: "25 May 2021"
output: html_document
---

# Setup
```{r setup, include=FALSE}
rm(list=ls()) # Clear workspace
setwd(dirname(rstudioapi::getActiveDocumentContext()$path)) #Set directory at current (make sure file is saved locally)

library(readxl) # Import excel sheets
library(openxlsx) # Create excel sheets
library(tidyverse) # tidy data
library(panelr) # Convert data from wide to long
library(lattice) # Regressions
library(lme4) # Generalized and mixed linear models
library(nlme) # gls
library(emmeans) # Pairwise comparisons

```

# Data import
```{r data import, include=FALSE}
# Import excel sheet
raw.data <- read_excel("cleaning_exp.xlsx", sheet = "RAW DATA")
raw.data.1 <- data.frame(raw.data)

# Insert new columns Treatment & Size
raw.data.1 <- as.data.frame(append(raw.data.1,list(Treatment = "",Size = ""),after = 7))

# Fill in the newly created variable 'Size' with conditional values from 'Length'
raw.data.1$Size <- ifelse(
  raw.data.1$Length.S1 < 3.4, "Small",
  ifelse(raw.data.1$Length.S1 < 6.4, "Medium","Large"))

# Fill in the newly created variable 'Treatment' with conditional values from 'Structure'
raw.data.1$Treatment <- ifelse(
  raw.data.1$Structure %in% c("Tree 095", "Tree 089","Tree 079"),"Weekly",
  ifelse(raw.data.1$Structure %in% c("Tree 092", "Tree 093", "Tree 088"), "Monthly",
         ifelse(raw.data.1$Structure %in% c("Tree 099", "Tree 098", "Tree 094"), "Quarterly","Never")))

# Insert new columns to calculate average SGR over whole period
raw.data.1 <- as.data.frame(append(raw.data.1,list(Date.S8 = "2019-12-24", Length.S8 = NA, Width1.S8 = NA, 
              Width2.S8 = NA, EV.S8 = NA, Condition.S8 = NA, Cause_death.S8 = NA, s_g_r.S8 = NA, 
              Comments.S8 = NA), after = 73))

# Calculate SGR over whole period
raw.data.1$s_g_r.S8 <- log(raw.data.1$EV.S7/raw.data.1$EV.S1)/as.numeric(as.Date(as.character(raw.data.1$Date.S7), 
                       format="%Y-%m-%d") - as.Date(as.character(raw.data.1$Date.S1), format="%Y-%m-%d"))

# Calculate change in EV as percentage over whole period (NB: expressed as percentage, as opposed to other EV values)
raw.data.1$EV.S8 <- ((raw.data.1$EV.S7-raw.data.1$EV.S1)/raw.data.1$EV.S1)*100

# Fill in end Condition for Average time factor (i.e. end survival will be used in analysis)
raw.data.1$Condition.S8 <- raw.data.1$Condition.S7

# Convert to long dataframe
raw.data.2 <- as.data.frame(long_panel(raw.data.1, prefix = ".S", begin = 1, end = 8, label_location = "end"))

# Set correct names and data formats
names(raw.data.2)[20] <- "SGR"
raw.data.2$Species <- fct_recode(raw.data.2$Species, 'Pocillopora verrucosa' = "Pocillopora verucosa")
raw.data.2$Species <- fct_recode(raw.data.2$Species, 'Acropora cf formosa' = "Acropora formosa")
raw.data.2$SGR[raw.data.2$SGR == "NA"] <- NA
raw.data.2$Cause_death[raw.data.2$Cause_death == "NA"] <- NA
raw.data.2$Structure <- factor(raw.data.2$Structure)
species.order = c("Acropora cf formosa", "Acropora verweyi", "Pocillopora verrucosa", "Porites cylindrica")
raw.data.2$Species <- factor(raw.data.2$Species, levels = species.order)
raw.data.2$Size <- ordered(raw.data.2$Size, levels = c("Small", "Medium", "Large"))
raw.data.2$Treatment <- ordered(raw.data.2$Treatment, c("Weekly", "Monthly", "Quarterly", "Never"))
raw.data.2$SGR <- as.numeric(raw.data.2$SGR)
raw.data.2$Cause_death <- factor(raw.data.2$Cause_death)

# raw.data.2$Date <- as.Date(raw.data.2$Date, format = "%d/%m/%Y")
raw.data.2$Date <- format(raw.data.2$Date, "%m/%Y")
raw.data.2$Date <- factor(raw.data.2$Date)

# Merge overlapping months for visualisation purposes
raw.data.2$Date[raw.data.2$Date == "09/2018"] <- "10/2018"
raw.data.2$Date[raw.data.2$Date == "05/2019"] <- "04/2019"
raw.data.2$Date <- droplevels(raw.data.2$Date)
date.order = c("10/2018", "12/2018", "02/2019", "04/2019", "06/2019", "08/2019", "10/2019", "12/2019")
raw.data.2$Date <- factor(raw.data.2$Date, levels = date.order)
raw.data.2$Date <- fct_recode(raw.data.2$Date, 'Average' = "12/2019")

# Drop and reorder some columns
clean.data <- raw.data.2 %>%
  select(-c("wave", "ID", "Origin","Batch", "Select", "Width1", "Width2", "Alive","Comments"))
clean.data <- clean.data[,c(1,3,2,4,5,6,7,8,11,10,12,9)]

# Tidy formatting data frame
clean.data$Length <- round(clean.data$Length, 1)
clean.data$EV <- round(clean.data$EV, 0)
clean.data$SGR <- round(clean.data$SGR, 3)


```

# Data cleaning
```{r data cleaning}

# Remove rows with Exclude: influenced by factors of non-interest (e.g. corallivory, wrong start size/health)
clean.data.1 <- clean.data[-which(clean.data$Cause_death == "Exclude"),]

# Create subset to inspect missing values
missing <- subset(clean.data.1, Cause_death == "Missing")
missing <- subset(missing, Date == "10/2019")

# Summary of missing values 
# Indicating that missing fragments are roughly equally distributed accross Treatment
# Indicating that missing fragments occur more frequently for large fragments and for Acr for and Poc ver
summary(missing)
plot(missing$Cause_death, missing$Treatment)
plot(missing$Cause_death, missing$Species)
plot(missing$Cause_death, missing$Size)

# Decision to leave out missing fragments from analysis, as not related to Treatment
clean.data.1 <- clean.data.1[-which(clean.data.1$Cause_death == "Missing"),]

```

# Data exploration
```{r data exploration}

hist(clean.data.1$SGR)
hist(clean.data.1$Condition)
hist(clean.data.1$EV)

# Function to facilitate averaging dataset
data_summary <- function(data, varname, groupnames){
  require(plyr)
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE),
      n  = length(x[[col]]),
      se = sd(x[[col]], na.rm=TRUE)/sqrt(length(x)))
  }
  data_sum<-ddply(data, groupnames, .fun=summary_func,
                  varname)
  data_sum <- rename(data_sum, c("mean" = varname))
 return(data_sum)
}

# Get averages, split per Species, Size, Treatment and Date
data.summary <- data_summary(clean.data.1, varname = "SGR", groupnames = c("Species", "Size", "Treatment", "Date"))

ggplot(data.summary, aes(x = Date, fill = Size, y = SGR))+
  geom_bar(stat = "identity", position = position_dodge())+
  labs(y = "SGR")+ facet_grid(cols=vars(Treatment))+
  facet_wrap(~Species + Treatment)+
  geom_errorbar(aes(ymin=SGR-(2*se), ymax=SGR+(2*se)), width=.2,
                position=position_dodge(.9))+
  theme_light()

```

# SGR analysis
## Model selection

```{r SGR model selection}

# Create subset for SGR where Condition > 80: Only healthy corals should be used to determine growth rate
sgr.data <- subset(clean.data.1, Condition > 80 | is.na(Condition))
sgr.data <- subset(sgr.data, !(is.na(SGR))) # Exclude SGR with NA

# Simplify data by taking average SGR: ignore effect of time (bleaching event/seasons)
sgr.data <- subset(sgr.data, Date == "Average")

# Distribution of data
ggplot(sgr.data,aes(x=SGR))+geom_histogram(bins = 12)+theme_bw()

lme.sgr.0r  <- gls(SGR ~ Treatment*Species*Size, method = "REML", na.action = na.omit,
                  data = sgr.data) # AIC = -3369
lme.sgr.1r  <- lme(SGR ~ Treatment*Species*Size, method = "REML", na.action = na.omit, random = ~1 | Structure, 
                  data = sgr.data) # AIC = -3378

AIC(lme.sgr.0r, lme.sgr.1r) # Tree as random factor improves model substantially and solves pseudo-replication

lme.sgr.1  <- lme(SGR ~ Treatment*Species*Size, na.action = na.omit, random = ~1 | Structure, 
                  data = sgr.data) # AIC = -3378

anova(lme.sgr.1) # Three-way interaction just not significant, and considering multiple comparisons better to leave

# Comparing two-way interactions
lme.sgr.2  <- lme(SGR ~ Treatment*Species + Treatment*Size + Species*Size, 
                  na.action = na.omit, random = ~1 | Structure, data = sgr.data) # AIC = -3606

anova(lme.sgr.2) # Treatment*Size interaction only just significant, better to leave out

lme.sgr.3  <- lme(SGR ~ Treatment*Species + Species*Size, 
                  na.action = na.omit, random = ~1 | Structure, data = sgr.data) # AIC = -3688

anova(lme.sgr.3) # All terms highly significant: final model

AIC(lme.sgr.0, lme.sgr.1, lme.sgr.2, lme.sgr.3) # lme.sgr.3 clearly favoured by AIC

```

## Model validation
```{r SGR model validation}

op <- par(mfrow = c(2, 4), mar = c(5, 4, 1, 2))
plot(resid(lme.sgr.3, type = "normalized") ~ fitted(lme.sgr.3))
abline(0,0)
plot(sgr.data$SGR, resid(lme.sgr.3, type = "normalized"))
abline(0,0)
hist(resid(lme.sgr.3, type = "normalized"), main = "")
qqnorm(resid(lme.sgr.3, type = "normalized"))
plot(sgr.data$Size, resid(lme.sgr.3, type = "normalized"))
abline(0,0)
plot(sgr.data$Species, resid(lme.sgr.3, type = "normalized"))
abline(0,0)
plot(sgr.data$Treatment, resid(lme.sgr.3, type = "normalized"))
abline(0,0)
plot(fitted(lme.sgr.3) ~ sgr.data$SGR)
par(op)

coplot(resid(lme.sgr.3, type = "normalized") ~ Size | Species, data = sgr.data)

```

## Post hoc and plots
```{r}

## Species*Size
lsmeans(lme.sgr.2, pairwise ~ Species*Size, adjust = "tukey")

se.sgr.2TS <- emmeans(lme.sgr.2, pairwise~Species*Size, type="response")

# Get averages, split per Species and Size
sgr.2SS.summary <- data_summary(sgr.data, varname = "SGR", groupnames = c("Size", "Species"))

ggplot(sgr.2SS.summary, aes(x = Species, fill = Size, y = SGR))+
  geom_bar(stat = "identity", position = position_dodge())+
  labs(y = "SGR")+ #+facet_grid(cols=vars(Species)) +
  geom_errorbar(aes(ymin=SGR-(2*se), ymax=SGR+(2*se)), width=.2,
                position=position_dodge(.9))+
  theme_light()

## Species*Treatment
lsmeans(lme.sgr.2, pairwise ~ Species*Treatment, adjust = "tukey")

se.sgr.2ST <- emmeans(lme.sgr.2, pairwise~Species*Treatment, type="response")

# Get averages, split per Species and Size
sgr.2ST.summary <- data_summary(sgr.data, varname = "SGR", groupnames = c("Species", "Treatment"))

ggplot(sgr.2ST.summary, aes(x = Species, fill = Treatment, y = SGR))+
  geom_bar(stat = "identity", position = position_dodge())+
  labs(y = "SGR")+ #+facet_grid(cols=vars(Species)) +
  geom_errorbar(aes(ymin=SGR-(2*se), ymax=SGR+(2*se)), width=.2,
                position=position_dodge(.9))+
  theme_light()
```



## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

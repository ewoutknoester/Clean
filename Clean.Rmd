---
title: "Clean"
author: "Ewout Knoester"
date: "25 May 2021"
output: html_document
---

# Setup
```{r setup, include=FALSE}
rm(list=ls()) # Clear workspace
setwd(dirname(rstudioapi::getActiveDocumentContext()$path)) #Set directory at current (make sure file is saved locally)

library(readxl) # Import excel sheets
library(openxlsx) # Create excel sheets
library(tidyverse) # tidy data
library(panelr) # Convert data from wide to long


```

# Data import
```{r data import, include=FALSE}
# Import excel sheet
raw.data <- read_excel("cleaning_exp.xlsx", sheet = "RAW DATA")
raw.data.1 <- data.frame(raw.data)

# Insert new columns Treatment & Size
raw.data.1 <- as.data.frame(append(raw.data,list(Treatment = "",Size = ""),after = 7))

# Fill in the newly created variable 'Size' with conditional values from 'Length'
raw.data.1$Size <- ifelse(
  raw.data.1$Length.S1 < 3.4, "Small",
  ifelse(raw.data.1$Length.S1 < 6.4, "Medium","Large"))

# Fill in the newly created variable 'Treatment' with conditional values from 'Structure'
raw.data.1$Treatment <- ifelse(
  raw.data.1$Structure %in% c("Tree 095", "Tree 089","Tree 079"),"Weekly",
  ifelse(raw.data.1$Structure %in% c("Tree 092", "Tree 093", "Tree 088"), "Monthly",
         ifelse(raw.data.1$Structure %in% c("Tree 099", "Tree 098", "Tree 094"), "Quarterly","Never")))

# Convert to long dataframe
raw.data.2 <- as.data.frame(long_panel(raw.data.1, prefix = ".S", begin = 1, end = 7, label_location = "end"))

# Set correct names and data formats
names(raw.data.2)[20] <- "SGR"
raw.data.2$Species <- fct_recode(raw.data.2$Species, 'Pocillopora verrucosa' = "Pocillopora verucosa")
raw.data.2$Species <- fct_recode(raw.data.2$Species, 'Acropora cf formosa' = "Acropora formosa")
raw.data.2$SGR[raw.data.2$SGR == "NA"] <- NA
raw.data.2$Cause_death[raw.data.2$Cause_death == "NA"] <- NA
raw.data.2$Structure <- factor(raw.data.2$Structure)
species.order = c("Acropora cf formosa", "Acropora verweyi", "Pocillopora verrucosa", "Porites cylindrica")
raw.data.2$Species <- factor(raw.data.2$Species, levels = species.order)
raw.data.2$Size <- ordered(raw.data.2$Size, levels = c("Small", "Medium", "Large"))
raw.data.2$Treatment <- ordered(raw.data.2$Treatment, c("Weekly", "Monthly", "Quarterly", "Never"))
raw.data.2$SGR <- as.numeric(raw.data.2$SGR)
raw.data.2$Cause_death <- factor(raw.data.2$Cause_death)

# raw.data.2$Date <- as.Date(raw.data.2$Date, format = "%d/%m/%Y")
raw.data.2$Date <- format(raw.data.2$Date, "%m/%Y")
raw.data.2$Date <- factor(raw.data.2$Date)

# Merge overlapping months for visualisation purposes
raw.data.2$Date[raw.data.2$Date == "09/2018"] <- "10/2018"
raw.data.2$Date[raw.data.2$Date == "05/2019"] <- "04/2019"
raw.data.2$Date <- droplevels(raw.data.2$Date)
date.order = c("10/2018", "12/2018", "02/2019", "04/2019", "06/2019", "08/2019", "10/2019")
raw.data.2$Date <- factor(raw.data.2$Date, levels = date.order)

# Drop and reorder some columns
clean.data <- raw.data.2 %>%
  select(-c("wave", "ID", "Origin","Batch", "Select", "Width1", "Width2", "Alive","Comments"))
clean.data <- clean.data[,c(1,3,2,4,5,6,7,8,11,10,12,9)]

# Tidy formatting data frame
clean.data$Length <- round(clean.data$Length, 1)
clean.data$EV <- round(clean.data$EV, 0)
clean.data$SGR <- round(clean.data$SGR, 3)


```

# Data cleaning
```{r data cleaning}

# Remove rows with Exclude: influenced by factors of non-interest (e.g. corallivory, wrong start size/health)
clean.data.1 <- clean.data[-which(clean.data$Cause_death == "Exclude"),]

# Create subset to inspect missing values
missing <- subset(clean.data.1, Cause_death == "Missing")
missing <- subset(missing, Date == "10/2019")

# Summary of missing values 
# Indicating that missing fragments are roughly equally distributed accross Treatment
# Indicating that missing fragments occur more frequently for large fragments and for Acr for and Poc ver
summary(missing)
plot(missing$Cause_death, missing$Treatment)
plot(missing$Cause_death, missing$Species)
plot(missing$Cause_death, missing$Size)

# Decision to leave out missing fragments from analysis, as not related to Treatment
clean.data.1 <- clean.data.1[-which(clean.data.1$Cause_death == "Missing"),]

```

# Data exploration
```{r data exploration}

plot(clean.data.1$Treatment, clean.data.1$Condition)
plot(clean.data.1$Treatment, clean.data.1$SGR)

plot(clean.data.1$Species, clean.data.1$Condition)
plot(clean.data.1$Species, clean.data.1$SGR)

plot(clean.data.1$Size, clean.data.1$Condition)
plot(clean.data.1$Size, clean.data.1$SGR)

hist(clean.data.1$SGR)
hist(clean.data.1$Condition)
hist(clean.data.1$EV)


```



## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
